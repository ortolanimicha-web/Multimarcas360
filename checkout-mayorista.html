<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Pedido Mayorista - Multimarcas 360</title>
    <link rel="stylesheet" href="style.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="mayorista-theme">

    <header class="mayorista-header-mini">
        <a href="mayorista.html">
            <i class="fas fa-arrow-left"></i> <span class="desktop-text">Volver al Cat√°logo</span>
        </a>
        <h1>FINALIZAR PEDIDO</h1>
        <div style="width: 80px;"></div> </header>

    <main class="checkout-container">
        
        <div class="checkout-card">
            <h2 style="font-family: 'Playfair Display'; text-align: center; color: #d4af37;">Datos de Env√≠o y Pago</h2>
            <p style="text-align: center; color: #666; margin-bottom: 2rem;">Completa tus datos para preparar el pedido antes de enviar el WhatsApp.</p>

            <form id="mayorista-checkout-form">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="cliente-nombre">Nombre *</label>
                        <input type="text" id="cliente-nombre" required placeholder="Tu nombre">
                    </div>
                    <div class="form-group">
                        <label for="cliente-apellido">Apellido *</label>
                        <input type="text" id="cliente-apellido" required placeholder="Tu apellido">
                    </div>
                </div>

                <div class="form-group">
                    <label for="cliente-direccion">Direcci√≥n de Entrega (Local o Casa) *</label>
                    <input type="text" id="cliente-direccion" required placeholder="Calle, n√∫mero, barrio, ciudad...">
                </div>

                <div class="form-group">
                    <label for="cliente-horario">Horario de preferencia para recibir *</label>
                    <input type="text" id="cliente-horario" required placeholder="Ej: De 9 a 13hs o por la tarde">
                </div>

                <div class="form-group">
                    <label for="cliente-pago">M√©todo de Pago *</label>
                    <select id="cliente-pago" required>
                        <option value="">Selecciona una opci√≥n...</option>
                        <option value="Efectivo">Efectivo (Contraentrega)</option>
                        <option value="Transferencia">Transferencia Bancaria</option>
                        <option value="Deposito">Dep√≥sito Bancario</option>
                        <option value="Acordar">Acordar con el vendedor</option>
                    </select>
                </div>

                <div class="checkout-summary">
                    <p>Total Estimado del Pedido:</p>
                    <h3 id="checkout-total-display">$0.00</h3>
                </div>

                <button type="submit" class="btn-whatsapp-final">
                    <i class="fab fa-whatsapp"></i> ENVIAR PEDIDO POR WHATSAPP
                </button>
            </form>
        </div>

    </main>

    <footer>
        <p>¬© 2025 Multimarcas 360 - √Årea Mayorista</p>
    </footer>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. Verificar Carrito al cargar
            // Aseguramos que la funci√≥n exista, si no, leemos manual el storage
            let carrito = [];
            try {
                if (typeof getCarritoFromStorage === 'function') {
                    carrito = getCarritoFromStorage();
                } else {
                    const storage = localStorage.getItem('carrito');
                    carrito = storage ? JSON.parse(storage) : [];
                }
            } catch (e) { console.error("Error leyendo carrito", e); }

            if (!carrito || carrito.length === 0) {
                alert("El carrito est√° vac√≠o.");
                window.location.href = 'mayorista.html';
                return;
            }

            // 2. Calcular y mostrar total visualmente
            const total = carrito.reduce((acc, item) => acc + (item.precio * item.cantidad), 0);
            const displayTotal = document.getElementById('checkout-total-display');
            if(displayTotal) displayTotal.textContent = "$" + total.toFixed(2);

            // 3. LOGICA DE ENV√çO DIRECTA (Sin depender de app.js/Firebase)
            const form = document.getElementById('mayorista-checkout-form');
            
            if (form) {
                // Eliminamos cualquier listener previo clonando el nodo (opcional, por seguridad)
                const newForm = form.cloneNode(true);
                form.parentNode.replaceChild(newForm, form);

                newForm.addEventListener('submit', (e) => {
                    e.preventDefault(); // Evita recarga

                    // Datos del Cliente
                    const nombre = document.getElementById('cliente-nombre').value.trim();
                    const apellido = document.getElementById('cliente-apellido').value.trim();
                    const direccion = document.getElementById('cliente-direccion').value.trim();
                    const horario = document.getElementById('cliente-horario').value.trim();
                    const pago = document.getElementById('cliente-pago').value;

                    // Construcci√≥n del Mensaje
                    let mensaje = `‚ú® *NUEVO PEDIDO MAYORISTA* ‚ú®\n\n`;
                    mensaje += `üë§ *CLIENTE:*\n${nombre} ${apellido}\n`;
                    mensaje += `üìç *Direcci√≥n:* ${direccion}\n`;
                    mensaje += `‚è∞ *Horario:* ${horario}\n`;
                    mensaje += `üí∞ *Pago:* ${pago}\n`;
                    mensaje += `--------------------------------\n\n`;
                    mensaje += `üì¶ *DETALLE DEL PEDIDO:*\n`;

                    let totalFinal = 0;
                    carrito.forEach(item => {
                        const precio = Number(item.precio);
                        const cantidad = Number(item.cantidad);
                        const subtotal = precio * cantidad;
                        totalFinal += subtotal;

                        // Icono seg√∫n si es reserva ($0) o compra normal
                        const bullet = precio === 0 ? 'üî• RESERVA' : '‚úÖ';
                        
                        mensaje += `${bullet} *${item.nombre}*\n`;
                        mensaje += `   Cant: ${cantidad} | Sub: $${subtotal.toFixed(2)}\n`;
                        if (item.nota) mensaje += `   üìù Nota: ${item.nota}\n`;
                    });

                    mensaje += `\n--------------------------------\n`;
                    mensaje += `üíµ *TOTAL FINAL: $${totalFinal.toFixed(2)}*`;

                    // Enviar a WhatsApp
                    const numeroWhatsApp = "5493571618367"; 
                    const url = `https://api.whatsapp.com/send?phone=${numeroWhatsApp}&text=${encodeURIComponent(mensaje)}`;
                    
                    console.log("Enviando pedido a:", url); // Debug en consola
                    
                    // Usar window.open para asegurar compatibilidad m√≥vil
                    window.open(url, '_blank');
                    
                    // Opcional: Vaciar carrito tras √©xito (descomentar si deseas)
                    // localStorage.setItem('carrito', '[]');
                    // window.location.href = 'index.html'; 
                });
            }
        });
    </script>
</body>
</html>